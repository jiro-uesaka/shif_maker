# シフト自動作成サイト【シフメーカー】

## サイト概要
＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿  
｜　○○店：1月　 ｜　公休数：10日　｜　所定労働時間：168h｜   
｜　　　｜　１　｜　２　｜　３　｜　４　｜　５　｜　６　｜  
｜＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿  
｜　　　｜　月　｜　火　｜　水　｜　木　｜　金　｜　土　｜  
｜＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿  
｜山田　｜▼なし ｜▼公休 ｜▼なし ｜▼休み ｜▼なし ｜▼なし ｜…168h  
｜休：10｜　　　｜　　　｜　　　｜　　　｜　　　｜　　　｜  
｜～～～～～～～～～～～～～～～～～～～～～～～～～～～～  
｜　備考｜　　　｜移動　｜　　　｜　　　｜会議　｜　　　｜  
｜＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿  
｜佐藤　｜▼指休 ｜▼なし ｜▼出勤 ｜▼なし ｜▼遅番 ｜▼なし ｜…165h  
｜休：10｜　　　｜　　　｜　　　｜　　　｜16～20｜　　　｜  
｜～～～～～～～～～～～～～～～～～～～～～～～～～～～～  
｜　備考｜　　　｜　　　｜　　　｜　　　｜　　　｜　　　｜  
｜＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿  
｜田中一｜▼休み ｜▼なし ｜▼早番 ｜▼なし ｜▼指休 ｜▼なし ｜…166h  
｜休：10｜　　　｜　　　｜8～12 ｜　　　｜　　　｜　　　｜  
｜～～～～～～～～～～～～～～～～～～～～～～～～～～～～  
｜　備考｜　　　｜　　　｜遅でも｜　　　｜　　　｜　　　｜  
＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿  

会員登録することで本格的に使用可能なシフトの自動作成サイト。  
ゲストでもさらっと機能の試用は可能。  
スタッフと店舗の条件を事前に設定、もしくはシフト入力画面でスタッフの名前や店舗の条件などを設定し、  
シフト入力画面のセレクトボックスでそれぞれの日にちの出勤・指定休などを手入力で選択、  
その後シフト作成ボタンを押すと設定した条件で自動的にシフトを作成する。  

### サイトテーマ
シフト作成の負荷を軽減するための業務支援サイト  

### テーマを選んだ理由
シフト制の業種において管理職の大きな負担となっている毎月のシフト作成について、同じシフト制の業種でその苦労を
間近で見てきたことから少しでも負担を軽減できればと思いテーマを選定した。  
類似のサービスとしては、AIによるシフト作成支援を業務とした企業が展開している月額制や基本無料のものから
エクセルを用いたシェアウェアなども存在するが、前者は企業単位での利用登録が必要なものが多く個人で気軽に利用するには
ハードルが高く、後者はエクセルの導入が必要かつ操作方法は比較的簡易ではあるがそれでも一定のスキルが
必要であり特に中高年の管理者には厳しい部分がある。  
そのため、本サイトでは簡便さを重視しわかりやすく使いやすいに重きをおいて開発を行うこととする。  

### ターゲットユーザ
特にPCを用いたシフト作成の業務を苦手とする管理職  

### 主な利用シーン
実際にシフト作成までの流れの一例として  
１：事前にスタッフ・店舗などを設定する  
２：従業員からシフトの希望を集める  
３：シフトの希望に基づいて休みなどを手入力  
４：シフト作成ボタンを押すと、事前に設定した条件でシフトを生成  
５：条件を満たせないなどのエラーや生成後のシフトで修正したい箇所はシフト仮出力画面で修正可能  
６：作成したシフトをなんらかの形(pdf:excel:画像等)で出力する  
７：必要があれば作成したシフトをデータベースに保存する  

## 開発環境
- OS：Windows
- 言語：HTML,CSS,JavaScript,Ruby,(SQL)
- フレームワーク：Ruby on Rails
- (JSライブラリ：jQuery)
- IDE：Cloud9

## 使用予定素材(Gem)
- Kaminari  
スタッフ数が多くなる場合を想定し、スタッフの個別設定画面などで実装  
- enum_help  
公休と指定休などを識別するため  
- （jQuery）  
可能であれば  

## 設計書
必要な機能（かっこの中は可能であれば実装する項目）  

### 共通機能  
- ゲスト機能  
試しに使ってもらうために実装  
（自動作成はできないorスタッフや店舗の情報を保存できない）  
- 会員登録機能  
入力したスタッフ・店舗設定や作成したシフトの保存・呼び出しのため  
- （退会機能）  
設定していたスタッフ情報などを消去する  
- 入力テーブル表示機能  
datetaimeなどで月を取得し、31日、30日、28日でtableを呼び出す  
曜日も自動入力する  
- シフト入力機能  
セレクトボックスで登録した勤務パターンからシフトを選択できる  
備考欄には自由な文章を入力可能  
日毎に最大・最小勤務者数を変更可能  
（可能であればJQueryを用いた一括変更機能もつける）  
- シフト自動作成機能  
手入力で休みや出勤を指定した後、公休数や店舗の最大、最低勤務者数を考慮してシフトを自動生成する。  
機械的に休みを入力していった後、条件に合わない部分を修正させる。  
- 仮出力画面表示機能  
シフト生成後、手入力での変更が可能な画面を表示する（そこから再度自動生成は不可）  
- エラーメッセージ表示機能  
指定した条件を満たせない（指定休が入っていて最低勤務者数を満たせないなど）場合、仮出力画面でその旨を表示する  
- 出力機能  
シフト作成後、作ったシフトをexcelファイルなどで出力する  
自動生成の他に入力したシフトをそのまま出力もできるようにする  
（可能であれば出力したシフトに勤務タイプ・勤務時間を表示させるかも選択できるようにする）  
- （シフト保存機能）  
会員登録後、作成したシフトを保存し、随時呼び出して編集できる  
- （日付の色変更）  
定休日等があればわかりやすいように変更できる  

### スタッフ設定機能
#### 一般設定：
- （共通勤務時間）  
　全スタッフ共通で月間最大何時間勤務できるかを設定できる  
- 共通公休数設定機能    
　全スタッフ共通で月間最大何日公休を入れるか設定できる  
- （共通連続勤務可能日数）  
　全スタッフ共通で連続で何日勤務できるか設定できる  
- （共通連続勤務可能時間）  
　全スタッフ共通で最長で何時間連続で勤務できるか設定できる  
　8：00～20：00までの営業で最長１２時間の連続勤務可能時間に設定した場合、  
　朝から晩まで勤務した翌日は必ず9：00～のシフトになる、  
　前日14：00～20：00まで勤務した場合、翌日は朝8：00～勤務したら必ず14：00時までに終わるシフトが選択されるなど  
- 共通シフトタイプ設定機能  
　名前（早番、遅番など）と勤務時間（8：00～16：00、16：00～20：00など）、そのシフトが早番か遅番かを設定できる  
　実装順序２までは指定出・指定休のみ  
- （共通２連休設定）  
　全スタッフ共通で毎月２連休を何回入れるか設定できる  
- （共通３連休設定）  
　全スタッフ共通で毎月３連休を何回入れるか設定できる  
- （「早番と遅番を均等にする」）  
　早番と遅番が極力偏らないように全スタッフ共通で設定できる  
#### 個別設定：
- スタッフ追加機能  
　新たにスタッフを登録できる。追加したスタッフは入力テーブルに自動的に表示される  
- スタッフ変更機能  
　スタッフを削除したり登録情報を変更できる  
- （個別シフトタイプ）  
　各スタッフごとにシフト自動作成時に選択の候補となるシフトを設定できる  
　共通シフトタイプで設定したシフトのみ設定可能で、個別にこのスタッフだけのシフト、というような設定は不可  
- （勤務時間）  
　各スタッフ個別で月間最大何時間勤務できるかを設定できる（未入力なら共通設定が適用される）  
- 個別公休数設定機能  
　各スタッフ個別で月間最大何日公休を入れるか設定できる（未入力なら共通設定が適用される）  
- （２連休設定）  
　各スタッフ個別で毎月２連休を何回入れるか設定できる  
- （３連休設定）  
　各スタッフ個別で毎月３連休を何回入れるか設定できる  
- （「早番と遅番を均等にする」）  
　各スタッフ個別で早番と遅番が極力偏らないように設定できる  
- （勤務可能店舗設定）  
　どこの店舗で勤務できるかを設定できる  
- （店舗ごとの勤務優先度）  
　登録した店舗で同じ日に複数名のスタッフが勤務可能な場合、どのスタッフを優先的に勤務させるか設定できる  
- （スタッフ表示店舗設定）  
　どの店舗にどのスタッフを表示するか設定できる  
- （勤務をなるべく早番・遅番のみにする）  
　各スタッフ個別でシフトを極力早番・遅番に偏らせる。  
- （土日の休みを多くする）  
　各スタッフ個別で極力休みを土日に集中させる。  

### 店舗設定機能
- （店舗名変更）  
店舗の表示名を変更できるようにする  
- （営業時間設定）  
ここで設定した時間の間、最低勤務者数を満たせるようにシフトを作成する  
- 最低勤務者数設定  
店舗に一日最低何名のスタッフが必要かを設定できる  
- 最大勤務者数設定  
店舗に一日最大何名のスタッフが勤務できるかを設定できる  
- （店舗追加）  
店舗を追加で登録できる。追加した店舗ごとに各項目を設定することができる  
- 日ごとの最大・最低勤務者数設定機能  
繁忙期になりそうだからこの日は多めという風に設定できる  



### 実装順序（ひとまず２までの実装を目指す）
１：ゲスト機能、会員登録機能、入力テーブル表示機能、シフト入力機能、シフト作成機能（そのまま出力のみ）、出力機能、共通シフトタイプ、スタッフ追加、スタッフ変更を実装  
＝＞シフト作成のためのフォームなどを自分で用意しなくてもこのサイトで最低限のシフトは作成できる。  
（エクセル使えるスキル・環境がない、フォームを作成したり探すことが出来ない人には役立つ）  
２：共通勤務日数、勤務日数、最低勤務者数設定、最大勤務者数設定、日ごとの最大・最低勤務者数、シフト作成機能（休日のみ自動）を実装  
＝＞手入力した希望分以外の休日を自動で組むことができる。時間による交代制がない（フルタイムの勤務しかない）場合はこれで充分？  
３：営業時間設定、スタッフ設定機能（共通勤務時間、勤務時間、個別シフトタイプ、「早番と遅番を均等にする」）などを実装  
＝＞１日に複数名のスタッフが入れ替わりで勤務するシフトを作成できる  
４：店舗追加、勤務可能店舗設定、店舗ごとの勤務優先度、スタッフ表示店舗設定などを実装  
＝＞スタッフが一つの店舗に固定ではなく、複数店舗をローテーションするシフトを作成できる  
５：勤務をなるべく早番・遅番のみにする、共通２連休設定、２連休設定、土日の休みを多くするなどを実装  



### 実際にどのように自動生成するか
日次処理＝＞月末になったら月末処理を繰り返す  

#### 日次処理と月末処理について
- 日次処理の流れ  
processing_dayに現在処理中の日付を代入  
全スタッフの残休日数がそれぞれ０以下の場合  
　その日の現在の勤務者数＞その日の最大勤務者数になるか確認  
　なる場合、各スタッフの残休日数を比較し、一番多いスタッフ（同数ならIDの若いスタッフ）の  
 　「○day_rest（もしくは中間テーブル）」を休に（残休日数は０なので-1になる）  
　ならなければ翌日の処理に移る  
　なお、該当スタッフがすでに休になっている場合、次に残休日数が多い（複数名が該当する場合その中でIDが若い）  
　スタッフに休を入れ翌日へ（残休日数は０なので-1になる）  
一人でも１以上の場合  
　その日の現在の勤務者数-1≧その日の最低勤務者数になるか確認  
　なる場合、各スタッフの残休日数を比較し、一番多いスタッフ（同数ならIDの若いスタッフ）の  
　「○day_rest（もしくは中間テーブル）」を休に  
　ならなければ翌日の処理に移る  
　なお、該当スタッフがすでに休になっている場合、次に残休日数が多い（複数名が該当する場合その中でIDが若い）  
　スタッフに休を入れ翌日へ  
　その場合、次に残休日数が多いスタッフの残休日数が０以下でも休を入れる（0だったら-1になる）  
- 月末処理の流れ  
全スタッフの残休日数を確認  
スタッフの残休日数が全員０以下  
　「その日の出勤人数＞その日の最大勤務者数」が１日でも存在する（最大勤務日数よりも出勤可能数が多い）  
　　　再度月初から日次処理  
　「その日の出勤人数＞その日の最大勤務者数」が１日も存在しない  
　　残休日数が一番多い（シフト上の休日が少ない）スタッフと少ない（シフト上の休日が多い）スタッフの差を比較する  
　　差が絶対値で２以上なら修正テーブルを起動  
　　　試行回数ｎに+1  
　　　休日数がｎ番目に多いスタッフと一番少ないスタッフのIDを格納する  
　　　「休日数がｎ番目に多いスタッフが休になっていて、かつ一番少ないスタッフが出勤になっている」  
  　　　日にちがないか確認する  
　　　あった場合、休日数がｎ番目に多いスタッフを出勤に変更し一番少ないスタッフを休日にする  
　　　その上で再度月末処理を行う  
　　　なかった場合、試行回数ｎに+1から繰り返す  
　　　もし勤務可能スタッフ数と同じ回数試行しても上手くいかなければエラーメッセージと共に仮出力画面に遷移する  
　　差が絶対値で１（0以下なので-1：最大出勤者数を満たすために設定公休数より休みが多い状態）  
　　　休日数が一番多いスタッフが休になっている日で  
   　　　現在の出勤者数+1≦最大勤務者数を満たす日がないか１日から確認  
　　　あればその日の休を出勤に変更  
　　　なければ全ての日にちで現在の出勤者数+1≦最大勤務者数になるか確認する  
　　　条件に該当する（出勤が一人増えても最大勤務者数を超えない）日がある場合、  
　　　その日の休になっている一番IDの若いスタッフを出勤に変えて修正テーブルを起動  
　　　全ての日で条件に該当する場合、エラーメッセージと共にそのまま仮出力画面へ  
　　差が０  
　　　仮出力画面に遷移する  
スタッフの残休日数が一人でも１以上  
　「その日の出勤人数-1≧その日の最低勤務者数」が１日でも存在する  
　　　再度月初から日次処理  
　「その日の出勤人数-1≧その日の最低勤務者数」が１日も存在しない（現在の公休数では最低勤務日数を満たせない）  
　　残休日数が一番多い（シフト上の休日が少ない）スタッフと  
　　少ない（シフト上の休日が多い）スタッフの差を絶対値で比較する  
　　差が絶対値で２以上なら修正テーブルを起動  
　　　試行回数ｎに+1  
　　　休日数がｎ番目に多いスタッフと一番少ないスタッフのIDを格納する  
　　　「休日数がｎ番目に多いスタッフが休になっていて、かつ一番少ないスタッフが出勤になっている」  
　　　日にちがないか確認する  
　　　あった場合、休日数がｎ番目に多いスタッフを出勤に変更し一番少ないスタッフを休日にする  
　　　その上で再度月末処理を行う  
　　　なかった場合、試行回数ｎに+1から繰り返す  
　　　もし勤務可能スタッフ数と同じ回数試行しても上手くいかなければエラーメッセージと共に仮出力画面に遷移する  
　　差が絶対値で１（１以上なので+1：最低出勤者数を満たすために設定公休数より休みが少ない状態）  
　　　休日数が一番少ないスタッフが出勤になっている日で  
　　　現在の出勤者数-1＜最低勤務者数を満たさない日がないか１日から確認  
　　　あればその日の休を出勤に変更  
　　　なければ全ての日にちで現在の出勤者数-1≧最低勤務者数になるか確認する  
　　　条件に該当する（出勤が一人減っても最低勤務者数を割らない）日がある場合、  
　　　その日の出勤になっている一番IDの若いスタッフを休に変えて修正テーブルを起動  
　　　全ての日で条件に該当しない場合、エラーメッセージと共にそのまま仮出力画面へ  
　　差が０  
　　　エラーメッセージと共に仮出力画面に遷移する  
